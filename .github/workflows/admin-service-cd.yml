name: Admin Service CD

on:
  repository_dispatch:
    types: [deploy-admin-service]
  workflow_dispatch:
    inputs:
      version:
        description: 'Admin service version to deploy'
        required: true
        default: 'latest'

env:
  AWS_REGION: us-east-1
  SERVICE_NAME: admin-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Parse deployment information
      id: deployment
      run: |
        echo "âš™ï¸ Admin Service CD Pipeline Started"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          COMMIT_SHA="${{ github.sha }}"
          echo "ğŸ“‹ Manual deployment triggered"
        else
          VERSION="${{ github.event.client_payload.version }}"
          COMMIT_SHA="${{ github.event.client_payload.commit_sha }}"
          echo "ğŸ¤– Automatic deployment from CI"
        fi
        
        if [ -z "$VERSION" ]; then
          echo "âŒ No version specified"
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ Deploying Admin Service version: $VERSION"
        echo "ğŸ”— From commit: $COMMIT_SHA"

    - name: Verify ECR image exists
      run: |
        VERSION="${{ steps.deployment.outputs.version }}"
        
        echo "ğŸ” Verifying Admin Service image exists in ECR..."
        aws ecr-public describe-images \
          --repository-name "cj-admin-svc" \
          --image-ids imageTag="$VERSION" \
          --region us-east-1 || {
          echo "âŒ Admin Service image $VERSION not found in ECR"
          exit 1
        }
        echo "âœ… Admin Service image $VERSION found in ECR"

    - name: Clone cjet-k8s repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/cjet-k8s-public
        token: ${{ secrets.K8S_REPO_TOKEN }}
        path: cjet-k8s-public
        ref: main

    - name: Update Admin Service in Helm values
      run: |
        cd cjet-k8s/helm
        VERSION="${{ steps.deployment.outputs.version }}"
        
        echo "ğŸ“ Current Helm values (admin section):"
        grep -A10 "^  admin:" values.yaml || echo "Admin section not found"
        
        # Update only the admin service tag
        sed -i '/^  admin:/,/^  [a-zA-Z]/ { 
          /tag:/ {
            s/tag: .*/tag: '$VERSION'/
          }
        }' values.yaml
        
        echo ""
        echo "âœ… Updated admin service to version: $VERSION"
        echo "ğŸ“ Updated Helm values (admin section):"
        grep -A10 "^  admin:" values.yaml

    - name: Commit and push Admin Service update
      run: |
        cd cjet-k8s
        VERSION="${{ steps.deployment.outputs.version }}"
        COMMIT_SHA="${{ steps.deployment.outputs.commit_sha }}"
        
        # Git configuration
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Admin Service CD"
        
        # Check for changes
        if git diff --quiet; then
          echo "â„¹ï¸ No changes to commit"
          exit 0
        fi
        
        # Commit changes
        git add helm/values.yaml
        git commit -m "âš™ï¸ Update admin-service to $VERSION

        ğŸ”§ Service: admin-service
        ğŸ“¦ Version: $VERSION
        ğŸ”— Commit: $COMMIT_SHA
        âš¡ Updated by Admin Service CD pipeline

        ğŸ¤– Generated with GitHub Actions"
        
        # Push changes
        git push origin main
        
        echo "âœ… Admin Service deployment committed and pushed"
        echo "ğŸ‰ ArgoCD will automatically sync the changes"

    - name: Deployment summary
      run: |
        VERSION="${{ steps.deployment.outputs.version }}"
        
        echo "ğŸ‰ Admin Service CD completed successfully!"
        echo ""
        echo "ğŸ“‹ Deployment Summary:"
        echo "  ğŸ”§ Service: admin-service"
        echo "  ğŸ“¦ Version: $VERSION"
        echo "  ğŸ¯ Target: Kubernetes cluster"
        echo "  ğŸ“ Updated: cjet-k8s/helm/values.yaml"
        echo ""
        echo "â³ Next steps:"
        echo "  1. ArgoCD will detect the changes automatically"
        echo "  2. Admin service will be deployed with rolling update"
        echo "  3. Monitor the deployment in ArgoCD dashboard"
        echo ""
        echo "ğŸ”— ArgoCD will deploy to:"
        echo "  â€¢ Namespace: user"
        echo "  â€¢ Service: admin-service"
        echo "  â€¢ Image: public.ecr.aws/v3g6g4v7/cj-admin-svc:$VERSION"